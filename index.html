<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Cosmic Lipstick - Final Phase</title>
<style>
    body { margin: 0; overflow: hidden; background-color: #050505; cursor: none; }
    canvas { display: block; }
</style>
</head>
<body>
<canvas id="gameCanvas"></canvas>

<script>
const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');
canvas.width = window.innerWidth;
canvas.height = window.innerHeight;

// --- ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ & å¼¾ ---
let player = { x: 100, y: canvas.height / 2, width: 60, height: 30, colorBody: '#FF69B4', colorTip: '#FF1493' };
let mouseY = canvas.height / 2;
let bullets = [];

// --- ğŸ¨ å¡—ã‚Šæ›¿ãˆã‚·ã‚¹ãƒ†ãƒ  (Phase 3 è¿½åŠ ) ---
let paintTrails = []; // å¡—ã‚‰ã‚ŒãŸå ´æ‰€ã®åº§æ¨™ã‚’ä¿å­˜ã™ã‚‹é…åˆ—

// --- ğŸŒŸ æ˜Ÿç©ºã®è¨­å®š ---
let stars = [];
for (let i = 0; i < 150; i++) {
    stars.push({
        x: Math.random() * canvas.width, y: Math.random() * canvas.height,
        size: Math.random() * 1.5, opacity: Math.random(), twinkleSpeed: 0.02 + Math.random() * 0.05
    });
}

// --- ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ ---
window.addEventListener('mousemove', (e) => { mouseY = e.clientY; });
window.addEventListener('mousedown', () => {
    bullets.push({ x: player.x + player.width/2, y: player.y, speed: 20, size: 30 });
});

// --- æç”»é–¢æ•° ---

// 1. ãƒ¢ãƒã‚¯ãƒ­ã®æ˜Ÿç©ºã‚’æã
function drawStars() {
    ctx.fillStyle = "white";
    stars.forEach(s => {
        s.opacity += s.twinkleSpeed;
        if (s.opacity > 1 || s.opacity < 0) s.twinkleSpeed *= -1;
        ctx.globalAlpha = Math.abs(s.opacity);
        ctx.beginPath(); ctx.arc(s.x, s.y, s.size, 0, Math.PI * 2); ctx.fill();
    });
    ctx.globalAlpha = 1.0;
}

// 2. å¡—ã‚‰ã‚ŒãŸãƒ”ãƒ³ã‚¯ã®å ´æ‰€ã‚’æã (ã“ã“ãŒé­”æ³•ï¼)
function drawPaintedArea(time) {
    if (paintTrails.length === 0) return;

    ctx.save();
    
    // ã‚¯ãƒªãƒƒãƒ”ãƒ³ã‚°ï¼šã“ã‚Œä»¥é™ã®æç”»ã¯ã€ã“ã“ã§æŒ‡å®šã—ãŸå††ã®ä¸­ã«ã—ã‹è¡¨ç¤ºã•ã‚Œãªã„
    ctx.beginPath();
    paintTrails.forEach(p => {
        ctx.moveTo(p.x, p.y);
        ctx.arc(p.x, p.y, p.radius, 0, Math.PI * 2);
    });
    ctx.clip();

    // --- ã“ã®ä¸­ã ã‘ã€Œãƒã‚ªãƒ³ãƒ”ãƒ³ã‚¯ã®ä¸–ç•Œï¼ˆPhase 0.1ï¼‰ã€ã‚’å†ç¾ ---
    const gradient = ctx.createRadialGradient(canvas.width / 2, canvas.height / 2, 0, canvas.width / 2, canvas.height / 2, canvas.width);
    const intensity = Math.sin(time * 0.05) * 20 + 40;
    gradient.addColorStop(0, `hsl(300, 100%, ${intensity}%)`);
    gradient.addColorStop(1, '#220022');
    ctx.fillStyle = gradient;
    ctx.fillRect(0, 0, canvas.width, canvas.height);

    // å¡—ã‚Šã¤ã¶ã—ãŸå ´æ‰€ã®ãƒ•ãƒã‚’å°‘ã—å…‰ã‚‰ã›ã‚‹
    ctx.shadowBlur = 15; ctx.shadowColor = "#FF00FF";
    
    ctx.restore();
}

function drawPlayer() {
    ctx.save();
    ctx.translate(player.x, player.y);
    ctx.shadowBlur = 20; ctx.shadowColor = player.colorBody;
    ctx.fillStyle = player.colorBody;
    ctx.beginPath(); ctx.roundRect(-player.width/2, -player.height/2, player.width*0.7, player.height, [5, 0, 0, 5]); ctx.fill();
    ctx.fillStyle = player.colorTip;
    ctx.beginPath(); ctx.moveTo(player.width*0.2, -player.height/2 + 5); ctx.lineTo(player.width/2, -player.height/4); ctx.lineTo(player.width/2, player.height/4); ctx.lineTo(player.width*0.2, player.height/2 - 5); ctx.closePath(); ctx.fill();
    ctx.restore();
}

function updateBullets() {
    bullets.forEach((b, i) => {
        b.x += b.speed;
        // å¼¾ãŒé€šã£ãŸå ´æ‰€ã«ã€Œå¡—ã‚‰ã‚ŒãŸãƒã‚¤ãƒ³ãƒˆã€ã‚’è¿½åŠ 
        paintTrails.push({ x: b.x, y: b.y, radius: b.size });
        
        ctx.save();
        ctx.shadowBlur = 15; ctx.shadowColor = '#FF00FF';
        ctx.fillStyle = 'rgba(255, 20, 147, 0.9)';
        ctx.beginPath(); ctx.ellipse(b.x, b.y, b.size, b.size/3, 0, 0, Math.PI * 2); ctx.fill();
        ctx.restore();
    });
    bullets = bullets.filter(b => b.x < canvas.width + 50);
}

// --- ãƒ¡ã‚¤ãƒ³ãƒ«ãƒ¼ãƒ— ---
let frameTime = 0;
function gameLoop() {
    frameTime++;
    // èƒŒæ™¯ï¼ˆãƒ¢ãƒã‚¯ãƒ­ï¼‰
    ctx.fillStyle = "#050505";
    ctx.fillRect(0, 0, canvas.width, canvas.height);

    drawStars();                // 1. æ™®é€šã®æ˜Ÿç©ºã‚’æã
    drawPaintedArea(frameTime); // 2. å¡—ã‚‰ã‚ŒãŸå ´æ‰€ã ã‘ãƒã‚ªãƒ³ã«ã™ã‚‹ (é­”æ³•ï¼)
    
    player.y += (mouseY - player.y) * 0.1;
    updateBullets();            // 3. å¼¾ã‚’å‹•ã‹ã—ã€è»Œè·¡ã‚’è¨˜éŒ²
    drawPlayer();               // 4. è‡ªæ©Ÿ
    
    requestAnimationFrame(gameLoop);
}

gameLoop();
</script>
</body>
</html>
